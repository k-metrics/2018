---
title: "第４回データ分析勉強会"
author: "【午後の部】効率的で綺麗な可視化 [鈴木さんぽう, CC BY-NC-SA 4.0]"
date: "`r format(Sys.Date(), format = '%Y年%m月%d日')`"
output:
  ioslides_presentation:
    css: style.css
    df_print: paged
    logo: fig/hex-ggplot2.png
    smaller: false
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

require(tidyverse)
```


## 本日の内容
1. 効率的で綺麗な可視化（６０～９０分程度）
1. **演習１～５（残り）**
    * アンスコムのデータ例
        * 第３回の演習結果を可視化してみる
    * 層別散布図
        * データの見方を変えてみる
    * ヒストグラム
        * 任意の階級幅で描いてみる
    * 層別箱ひげ図
        * 全体と因子別を比較してみる
    * オープン・クローズチャート
        * チケットの処理状況を把握する



# 演習１

## アンスコムのデータ例
アンスコムのデータ例（`anscombe`）を下図のようにグラフ化してください。

```{r, echo=FALSE}
anscombe %>%
  tibble::rownames_to_column("id") %>%
  tidyr::gather(key, value, -id) %>%
  tidyr::separate(col = key, into = c("axis", "group"), sep = 1) %>% # DT::datatable()
  tidyr::spread(axis, value) %>% 
  # dplyr::mutate(id = as.integer(id)) %>% dplyr::arrange(id) %>% 
  ggplot2::ggplot(ggplot2::aes(x, y))+
    ggplot2::geom_point()+
    ggplot2::geom_smooth(method = lm, se = FALSE, fullrange = TRUE)+
    ggplot2::facet_wrap(~ group, nrow = 2)
```


## ヒント
やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
整然データにする       | [第２回資料](./02_guidance_pm.html) | 
散布図を描く           | `ggplot2::geom_point()`         | 
回帰線を描く           | `ggplot2::geom_smooth()`        |
層別に描く             | `ggplot2::facet_wrap()`         | 



# 演習２

## 層別散布図
`iris`データセットを下図のようにグラフ化してください。

```{r, echo=FALSE}
iris %>% 
  tibble::rowid_to_column("ID") %>%
  tidyr::gather(key, value, -Species, -ID) %>% 
  # print() %>% 
  tidyr::separate(key, into = c("Part", "Dimension")) %>% # DT::datatable()
  # print() %>% 
  tidyr::spread(key = Dimension, value) %>% 
  # print() %>% 
  ggplot2::ggplot(ggplot2::aes(x = Length, y = Width)) + 
    ggplot2::geom_point(ggplot2::aes(colour = Species, shape = Part),
                        size = 2)
```


## ヒント
* 基本的な考え方は演習１に同じです

やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
点の形を指定する       | `ggplot2::aes(shape)`               | 



# 演習３

## ヒストグラム
第３回の『メトリクス統計分析入門』の演習問題にある生産性（階級幅200）と工数予実割合（階級幅0.25）のヒストグラムを描いてください。

```{r, echo=FALSE}
gg_prod <- "../data/data.csv" %>% 
  readr::read_csv(locale = locale(encoding = "CP932")) %>% 
  dplyr::rename(project = 'プロジェクト名', prod = '生産性',
                rate = '工数予実割合') %>% 
  dplyr::filter(!is.na(prod)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = prod)) + 
    ggplot2::geom_histogram(breaks = seq(0, 3000, 200))

gg_rate <- "../data/data.csv" %>% 
  readr::read_csv(locale = locale(encoding = "CP932")) %>% 
  dplyr::rename(project = 'プロジェクト名', prod = '生産性',
                rate = '工数予実割合') %>% 
  dplyr::filter(!is.na(rate)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = rate)) + 
    ggplot2::geom_histogram(breaks = seq(0, 3, 0.25))

gridExtra::grid.arrange(gg_prod, gg_rate)
```


## ヒント

やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
任意の階級を指定する   | `ggplot2::geom_histgram(breaks)`    | 
任意の数列を作成する   | `seq(start, end, by)`               | 



# 演習４

## 層別箱ひげ図
`iris`データセットを下図のようにグラフ化してください。

```{r, echo=FALSE, warning=FALSE}
iris %>% 
  dplyr::mutate(Species = "All") %>% 
  dplyr::bind_rows(iris) %>%
  dplyr::mutate(Species = as.factor(Species)) %>% 
  tibble::rowid_to_column("ID") %>%
  tidyr::gather(key, value, -Species, -ID) %>% 
  tidyr::separate(key, into = c("Part", "Dimension")) %>%
  tidyr::spread(key = Dimension, value) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species)) +
    ggplot2::geom_boxplot(ggplot2::aes(y = Length))
```


## ヒント
* 演習２の応用で因子分けされていない全体のデータをどうつくるかがポイントです

やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
データフレームをつなげる | `dplyr::row_bind()`               | 行方向
層別指定する           | `ggplot2::aes(group)`               | 
箱ひげ図を描く         | `ggplot2::geom_boxplot()`           | 



# 演習５

## オープン・クローズチャート
Redmineのチケットデータからチケットのオープン・クローズチャートを描いてください。

1. "Defect"（バグ）チケット1,000チケットが[対象データ](https://k-metrics.github.io/2018dasg/data/redmine_data_utf8.csv)です
1. 日付の実態は日時（開始・終了日時）なので日に変換する必要があります
1. 対象データ期間を調べ日付範囲を把握します
1. 日付範囲を考慮してチケット数の集計を行います
    * チケットオープン（＝開始日）、チケットクローズ（＝終了日）
    * **NAデータは0(zero)に変換**します
1. 集計データから累計を計算して色分け折れ線グラフを描きます


## 描画例
```{r, echo=FALSE, fig.height=5}

# バグチケットの日付の範囲を取得する
tickets_date <- "../data/redmine_data_utf8.csv" %>% 
  readr::read_csv() %>% 
  dplyr::select(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                OpenDateTime = '作成日', CloseDateTime = '終了日') %>% 
  dplyr::filter(Tracker == "Defect") %>% 
  dplyr::mutate(Date = lubridate::as_date(OpenDateTime)) %>% 
  dplyr::select(Date) %>% 
  dplyr::summarise(min = min(Date), max = max(Date))

# 日付の範囲のデータフレームを作成する
df_date <- seq(from = tickets_date$min, to = tickets_date$max, by = 1) %>% 
  tibble::as.tibble() %>% 
  dplyr::rename(Date = value)

# チケットオープンの日毎に集計し累計値を算出する
df_open <- "../data/redmine_data_utf8.csv" %>% 
  readr::read_csv() %>% 
  dplyr::select(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                OpenDateTime = '作成日', CloseDateTime = '終了日') %>% 
  dplyr::filter(Tracker == "Defect") %>% 
  dplyr::mutate(Date = lubridate::as_date(OpenDateTime)) %>% 
  dplyr::count(Date) %>% 
  dplyr::right_join(df_date) %>% 
  dplyr::mutate_at(vars(-Date), funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate(cum = cumsum(n)) %>% 
  dplyr::rename(open_n = n, open_cum = cum)

# チケットクローズの日毎に集計し累計値を算出する
df_close <- "../data/redmine_data_utf8.csv" %>% 
  readr::read_csv() %>% 
  dplyr::select(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                OpenDateTime = '作成日', CloseDateTime = '終了日') %>% 
  dplyr::filter(Tracker == "Defect" & Status == "Closed") %>%
  dplyr::mutate(Date = lubridate::as_date(CloseDateTime)) %>% 
  dplyr::count(Date) %>% 
  dplyr::right_join(df_date) %>% 
  dplyr::mutate_at(vars(-Date), funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate(cum = cumsum(n)) %>% 
  dplyr::rename(close_n = n, close_cum = cum)

df_date %>% 
  dplyr::left_join(df_open, by = "Date") %>% 
  dplyr::left_join(df_close, by = "Date") %>% 
  ggplot2::ggplot(aes(x = Date)) +
    ggplot2::geom_line(ggplot2::aes(y = open_cum), colour = "red") + 
    ggplot2::geom_line(ggplot2::aes(y = close_cum), colour = "blue") +
    ggplot2::labs(x = "日付", y = "チケット累計")
```


## ヒント
やりたいこと           | 利用する関数例                          | 備考
-----------------------|-----------------------------------------|---
最大値・最小値を求める | `min()`, `max()`, `range()` | 
日付に変換する         | `lubridate::as_date()`              | 
度数をカウントする     | `dplyr::count()`                    |
累計を求める           | `cumsum()`                          | 
置き換える             | `replace()`                         | 
NAか調べる             | `is.na()`                           |
データフレームを結合する | `dplyr::left/right_join()`        |


## License
CC BY-NC-SA 4.0, Sampo Suzuki