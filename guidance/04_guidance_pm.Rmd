---
title: "第４回データ分析勉強会"
author: "【午後の部】効率的で綺麗な可視化 [鈴木さんぽう, CC BY-NC-SA 4.0]"
date: "`r format(Sys.Date(), format = '%Y年%m月%d日')`"
output:
  ioslides_presentation:
    css: style.css
    df_print: paged
    logo: fig/hex-ggplot2.png
    smaller: false
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

require(tidyverse)
```


## 本日の内容
1. 効率的で綺麗な可視化（６０～９０分程度）
1. **演習１～５（残り）**
    * アンスコムのデータ例
        * 第３回の演習結果を可視化してみる
    * 層別散布図
        * データの見方を変えてみる
    * ヒストグラム
        * 任意の階級幅で描いてみる
    * 層別箱ひげ図
        * 全体と因子別を比較してみる
    * オープン・クローズチャート
        * チケットの処理状況を把握する



# 演習１

## アンスコムのデータ例
アンスコムのデータ例（`anscombe`）を下図のようにグラフ化してください。

```{r, echo=FALSE}
anscombe %>%
  tibble::rownames_to_column("id") %>%
  tidyr::gather(key, value, -id) %>%
  tidyr::separate(col = key, into = c("axis", "group"), sep = 1) %>% # DT::datatable()
  tidyr::spread(axis, value) %>% 
  # dplyr::mutate(id = as.integer(id)) %>% dplyr::arrange(id) %>% 
  ggplot2::ggplot(ggplot2::aes(x, y))+
    ggplot2::geom_point()+
    ggplot2::geom_smooth(method = lm, se = FALSE, fullrange = TRUE)+
    ggplot2::facet_wrap(~ group, nrow = 2)
```


## ヒント
やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
整然データにする       | [第２回資料](./02_guidance_pm.html) | 
散布図を描く           | `ggplot2::geom_point()`         | 
回帰線を描く           | `ggplot2::geom_smooth()`        |
層別に描く             | `ggplot2::facet_wrap()`         | 



# 演習２

## 層別散布図
`iris`データセットを下図のようにグラフ化してください。

```{r, echo=FALSE}
iris %>% 
  tibble::rowid_to_column("ID") %>%
  tidyr::gather(key, value, -Species, -ID) %>% 
  # print() %>% 
  tidyr::separate(key, into = c("Part", "Dimension")) %>% # DT::datatable()
  # print() %>% 
  tidyr::spread(key = Dimension, value) %>% 
  # print() %>% 
  ggplot2::ggplot(ggplot2::aes(x = Length, y = Width)) + 
    ggplot2::geom_point(ggplot2::aes(colour = Species, shape = Part),
                        size = 2)
```


## ヒント
* 基本的な考え方は演習１に同じです

やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
点の形を指定する       | `ggplot2::aes(shape)`               | 



# 演習３

## ヒストグラム
第３回の『メトリクス統計分析入門』の演習問題にある生産性（階級幅200）と工数予実割合（階級幅0.25）のヒストグラムを描いてください。

```{r, echo=FALSE}
gg_prod <- "../data/data.csv" %>% 
  readr::read_csv(locale = locale(encoding = "CP932")) %>% 
  dplyr::rename(project = 'プロジェクト名', prod = '生産性',
                rate = '工数予実割合') %>% 
  dplyr::filter(!is.na(prod)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = prod)) + 
    ggplot2::geom_histogram(breaks = seq(0, 3000, 200))

gg_rate <- "../data/data.csv" %>% 
  readr::read_csv(locale = locale(encoding = "CP932")) %>% 
  dplyr::rename(project = 'プロジェクト名', prod = '生産性',
                rate = '工数予実割合') %>% 
  dplyr::filter(!is.na(rate)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = rate)) + 
    ggplot2::geom_histogram(breaks = seq(0, 3, 0.25))

gridExtra::grid.arrange(gg_prod, gg_rate)
```


## ヒント

やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
任意の階級を指定する   | `ggplot2::geom_histgram(breaks)`    | 
任意の数列を作成する   | `seq(start, end, by)`               | 



# 演習４

## 層別箱ひげ図
`iris`データセットのがく片の長さを下図のようにグラフ化してください。

```{r, echo=FALSE, warning=FALSE}
iris %>% 
  dplyr::mutate(Species = "All") %>% 
  dplyr::bind_rows(iris) %>%
  dplyr::mutate(Species = as.factor(Species)) %>% 
  tibble::rowid_to_column("ID") %>%
  tidyr::gather(key, value, -Species, -ID) %>% 
  tidyr::separate(key, into = c("Part", "Dimension")) %>%
  tidyr::spread(key = Dimension, value) %>% 
  dplyr::filter(Part == "Sepal") %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species)) +
    ggplot2::geom_boxplot(ggplot2::aes(y = Length))
```


## ヒント
* 演習２の応用で因子分けされていない全体のデータをどうつくるかがポイントです

やりたいこと           | 利用する関数例                      | 備考
-----------------------|-------------------------------------|---
データフレームをつなげる | `dplyr::row_bind()`               | 行方向
層別指定する           | `ggplot2::aes(group)`               | 
箱ひげ図を描く         | `ggplot2::geom_boxplot()`           | 



# 演習５

## 層別箱ひげ図
`iris`データセットを下図のようにグラフ化してください。

```{r, echo=FALSE}
iris %>% 
  tidyr::gather(part, value, -Species) %>% 
  dplyr::group_by(Species, part) %>% 
  ggplot2::ggplot(ggplot2::aes(x = part, y = value)) + 
    ggplot2::geom_boxplot(ggplot2::aes(fill = Species), alpha = 0.5)
```



# 演習６

## オープン・クローズチャート
第３回の演習５で求めたデータを元にオープン・クローズチャートを描いてください。

```{r, echo=FALSE}
redmine <- "../data/redmine_data_utf8.csv" %>% 
  readr::read_csv() %>% 
  dplyr::select(ID = '#', status = 'ステータス', open = '作成日',
                close = '終了日') %>% 
  dplyr::mutate(open = lubridate::as_date(open),
                close = lubridate::as_date(close))

# Open - こちらがオープンしたチケット全部
open <- redmine %>% 
  dplyr::filter(open >= "2017-1-1" & open <= "2017-12-31") %>% 
  dplyr::mutate(week = lubridate::week(open)) %>% 
  dplyr::group_by(week) %>% 
  dplyr::summarise(open = n())

# Closed
close <- redmine %>% 
  dplyr::filter(open >= "2017-1-1" & open <= "2017-12-31") %>% 
  dplyr::filter(close >= "2017-1-1" & close <= "2017-12-31") %>% 
  dplyr::mutate(week = lubridate::week(close),
                status_flag = ifelse(status == "Closed", "closed", "open")) %>% 
  dplyr::mutate(flag = ifelse(status_flag == "closed", 1, 0)) %>% 
  dplyr::group_by(week) %>% 
  dplyr::summarise(close = sum(flag))

# 週次の集計
data.frame(week = seq(1:53)) %>% 
  dplyr::left_join(open, by = "week") %>% 
  dplyr::left_join(close, by = "week") %>% 
  dplyr::mutate(open = ifelse(is.na(open), 0, open),
                close = ifelse(is.na(close), 0, close)) %>% 
  dplyr::mutate(cumopen = cumsum(open), cumclose = cumsum(close)) %>% 
# unpivot
  tidyr::gather(key, value = tickets, -week) %>% 
  dplyr::filter(key == "cumopen" | key == "cumclose") %>% 
  ggplot2::ggplot(ggplot2::aes(x = week, y = tickets, colour = key)) + 
    ggplot2::geom_line()
```

## ヒント

やりたいこと           | 利用する関数例                     | 備考
-----------------------|------------------------------------|---
折れ線グラフを描く     | `ggplot2::geom_line`               | 



# 演習７

## オープン・クローズチャート
第３回の演習５で求めたデータを元に日毎のオープン、クローズ数を棒グラフで描いてください。

```{r, echo=FALSE}
redmine <- "../data/redmine_data_utf8.csv" %>% 
  readr::read_csv() %>% 
  dplyr::select(ID = '#', status = 'ステータス', open = '作成日',
                close = '終了日') %>% 
  dplyr::mutate(open = lubridate::as_date(open),
                close = lubridate::as_date(close))

# Open - こちらがオープンしたチケット全部
open <- redmine %>% 
  dplyr::filter(open >= "2017-1-1" & open <= "2017-12-31") %>% 
  dplyr::mutate(week = lubridate::week(open)) %>% 
  dplyr::group_by(week) %>% 
  dplyr::summarise(open = n())

# Closed
close <- redmine %>% 
  dplyr::filter(open >= "2017-1-1" & open <= "2017-12-31") %>% 
  dplyr::filter(close >= "2017-1-1" & close <= "2017-12-31") %>% 
  dplyr::mutate(week = lubridate::week(close),
                status_flag = ifelse(status == "Closed", "closed", "open")) %>% 
  dplyr::mutate(flag = ifelse(status_flag == "closed", 1, 0)) %>% 
  dplyr::group_by(week) %>% 
  dplyr::summarise(close = sum(flag))

# 週次の集計
data.frame(week = seq(1:53)) %>% 
  dplyr::left_join(open, by = "week") %>% 
  dplyr::left_join(close, by = "week") %>% 
  dplyr::mutate(open = ifelse(is.na(open), 0, open),
                close = ifelse(is.na(close), 0, close)) %>% 
  dplyr::mutate(cumopen = cumsum(open), cumclose = cumsum(close)) %>% 
# unpivot
  tidyr::gather(key, value = tickets, -week) %>% 
  dplyr::filter(key == "open" | key == "close") %>% 
  ggplot2::ggplot(ggplot2::aes(x = week, y = tickets, fill = key)) + 
    ggplot2::geom_bar(stat = "identity", position = "dodge", alpha = 0.5)
```


## ヒント

やりたいこと           | 利用する関数例                     | 備考
-----------------------|------------------------------------|---
棒グラフを描く         | `ggplot2::geom_bar`                | 
Y軸を指定して描く      | `ggplot2::geom_bar(stat)`          | 
因子毎に独立させて描く | `ggplot2::geom_bar(position)`      | 



# 演習８

## オープン・クローズチャート
演習５と演習６で描いたグラフを一つにまとめて描いてください。

```{r, echo=FALSE}
redmine <- "../data/redmine_data_utf8.csv" %>% 
  readr::read_csv() %>% 
  dplyr::select(ID = '#', status = 'ステータス', open = '作成日',
                close = '終了日') %>% 
  dplyr::mutate(open = lubridate::as_date(open),
                close = lubridate::as_date(close))

# Open - こちらがオープンしたチケット全部
open <- redmine %>% 
  dplyr::filter(open >= "2017-1-1" & open <= "2017-12-31") %>% 
  dplyr::mutate(week = lubridate::week(open)) %>% 
  dplyr::group_by(week) %>% 
  dplyr::summarise(open = n())

# Closed
close <- redmine %>% 
  dplyr::filter(open >= "2017-1-1" & open <= "2017-12-31") %>% 
  dplyr::filter(close >= "2017-1-1" & close <= "2017-12-31") %>% 
  dplyr::mutate(week = lubridate::week(close),
                status_flag = ifelse(status == "Closed", "closed", "open")) %>% 
  dplyr::mutate(flag = ifelse(status_flag == "closed", 1, 0)) %>% 
  dplyr::group_by(week) %>% 
  dplyr::summarise(close = sum(flag))

op <- data.frame(week = seq(1:53)) %>% 
  dplyr::left_join(open, by = "week") %>% 
  dplyr::left_join(close, by = "week") %>% 
  tidyr::gather(key, value = tickets, -week) %>% 
  dplyr::mutate(tickets = ifelse(is.na(tickets), 0, tickets))

data.frame(week = seq(1:53)) %>% 
  dplyr::left_join(open, by = "week") %>% 
  dplyr::left_join(close, by = "week") %>% 
  dplyr::mutate(open = ifelse(is.na(open), 0, open),
                close = ifelse(is.na(close), 0, close)) %>% 
  dplyr::mutate(cumopen = cumsum(open), cumclose = cumsum(close)) %>% 
  dplyr::select(-open, -close) %>% 
  dplyr::rename(open = cumopen, close = cumclose) %>% 
  tidyr::gather(key, value = tickets, -week) %>%
  dplyr::bind_cols(op, .) %>%
  dplyr::rename(daily = key, cum = key1) %>% 
  ggplot2::ggplot() +
    ggplot2::geom_bar(ggplot2::aes(x = week, y = tickets, fill = daily),
                      stat = "identity", position = "dodge", alpha = 0.5) +
    ggplot2::geom_line(ggplot2::aes(x = week1, y = tickets1, colour = cum))
```


## ヒント
ノーヒント



## License
CC BY-NC-SA 4.0, Sampo Suzuki