---
title: "第４回データ分析勉強会"
author: "【午前の部】効率的で綺麗な可視化 [鈴木さんぽう, CC BY-NC-SA 4.0]"
date: "`r format(Sys.Date(), format = '%Y年%m月%d日')`"
output:
  ioslides_presentation:
    css: style.css
    df_print: paged
    logo: fig/hex-ggplot2.png
    smaller: false
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

require(tidyverse)
```


## 本日の内容
1. **効率的で綺麗な可視化（午前）**
    * 整然データ（tidy data）と可視化
    * ggplot2とは？
    * ggplot2を使ってみる
    * 復習のためのリソース
1. 効率的で綺麗な可視化（午後）
    * 演習


# 効率的で綺麗な可視化


## 【復習】整然データとは？
* 整然データ（tidy data）とはデータハンドリングを習得する上で知っておくべき概念
    * 一言で表すと「（Coddの）第三正規形」
    * [整然データとは何か (Colorless Green Ideas)](http://id.fnshr.info/2017/01/09/tidy-data-intro/)
    * [整然データってなに？ (Speaker Deck)](https://speakerdeck.com/fnshr/zheng-ran-detatutenani)

* Rで最も使うデータ・フレーム型は整然データにしておくべき
    * 雑然データへの変換は簡単
    * 整然データなら可視化（見える化）も簡単


## ggplot2とは？
* Create Elegant Data Visualisations Using **the Grammar of Graphics**
    * 文字通り統一された文法で様々なグラフを描けるパッケージ
    * tidyverseシリーズなので**整然データ**を前提とした設計
    * といっても現時点ではパイプ演算子（`%>%`）は使えません

* 特徴
    * GIS（地理情報システム）などと同じ[**レイヤー構造**](http://id.fnshr.info/2011/10/22/ggplot2/)
    * **ggplot2::aes**の考え方を覚えるのがひとつのポイント
    * 出来ないないことは**関連パッケージで補える**柔軟性
        * QQプロットはqqplotr, 格子配置はggExtra, etc
    * 忖度してくれない（とりあえずでデータを突っ込んでも描画はしない）
        * base plotはとりあえずで突っ込んでも何か描いてくれる


## 必要なデータ形式
* ggplot2はデータフレーム型のデータを引数に取ります
* X軸用データ、Y軸用データ、グループ化データの三項目が基本的なデータ項目

　 | x           | y           | group, colour, fill, ... 
:-:|:----------:|:-----------:|:------------------:
1  | X軸用データ | Y軸用データ | グループ化データ 
2  | X軸用データ | Y軸用データ | グループ化データ 
3  | ...         | ...         | ... 

　  
つまり、**整然データ（iidy data）が必要**


# ggplot2を使ってみる

---

```{r}
ggplot2::ggplot(data = iris,
                mapping = ggplot2::aes(x = Sepal.Width, y = Sepal.Length,
                                       colour = Species)) +
    ggplot2::geom_point()
```

---

```{r}
ggplot2::ggplot(data = iris,
                mapping = ggplot2::aes(x = Species, y = Sepal.Length,
                                       colour = Species)) +
    ggplot2::geom_boxplot()
```


## ベースを決める`ggplot2::ggplot`関数
```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length))
```


## ベースに上書きしていくイメージ
```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point()
```


## 回帰直線を加えてみる
```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE)
```


## 層別で描いてみる
```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point(aes(colour = Species))
```


## 層別に回帰直線を加えてみる
```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point(aes(colour = Species)) + geom_smooth(method = "lm", se = FALSE)
```

## `ggplot2::aes`の指定位置がポイント
```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length, colour = Species)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE)
```

---

```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point(aes(colour = Species)) + geom_smooth(method = "lm", se = FALSE)
```

---

```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point() + geom_smooth(aes(colour = Species), method = "lm", se = FALSE)
```


## 因子毎にグラフを分ける
```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length, colour = Species)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE) + facet_wrap(~ Species)
```

---

```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point(aes(colour = Species)) + geom_smooth(method = "lm", se = FALSE) + 
  facet_wrap(~ Species)
```

---

```{r}
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point() + geom_smooth(aes(colour = Species), method = "lm", se = FALSE) + 
  facet_wrap(~ Species)
```

## ヒストグラム
```{r}
ggplot(iris, aes(x = Petal.Length)) + 
  geom_histogram()
```

## ヒストグラム
```{r}
ggplot(iris, aes(x = Petal.Length, fill = Species)) + 
  geom_histogram(alpha = 0.5)
```

## ヒストグラム
```{r}
ggplot(iris, aes(x = Petal.Length, fill = Species)) + 
  geom_histogram(position = "identity", alpha = 0.5)
```


## 密度推定を重ねあわせる
```{r}
ggplot(iris, aes(x = Petal.Length, fill = Species)) + 
  geom_histogram(aes(y = ..density..), position = "identity", alpha = 0.5) +
  geom_density(aes(colour = Species), alpha = 0.5)
```



## 階級幅の計算方法
`ggplot2::geom_histgram`関数のデフォルト設定では**階級数が30**に固定されています。階級数（まはた階級幅）を一意に決める方法はありませんが、Rでは`pritty`関数を用いることで適切な階級幅を求めることができます。

```{r, eval=FALSE}
pritty(x, n)
```

引数 | 説明
:---:|:-----
x    | ヒストグラムを描くためのデータ（ベクトル型）
n    | ヒストグラムの分割数（通常はスタージェスの公式などで求める）


## 階級幅を指定する
```{r}
breaks <- pretty(iris$Petal.Length, nclass.Sturges(iris$Petal.Length))
ggplot(iris, aes(x = Petal.Length, fill = Species)) + 
  geom_histogram(breaks = breaks, position = "identity", alpha = 0.5)
```


## 主な描画関数
geom object  | 描画内容       | 類似object
-------------|----------------|------------
geom_bar     | 棒グラフ       | geom_col
geom_boxplot | 箱ひげ図       | geom_violin
geom_dotplot | ドットチャート |
geom_histgram | ヒストグラム  | geom_density
geom_line    | 折れ線グラフ   | geom_path
geom_smooth  | 回帰線         | 
geom_text    | テキストラベル | geom_label


## 復習のためのリソース
* [ggplot2のすゝめ <i class="fa fa-external-link-square"></i>](https://k-metrics.github.io/cabinet/program/basics_ggplot2.html)
* [ggplot2あれこれ <i class="fa fa-external-link-square"></i>](https://k-metrics.github.io/cabinet/visualize/index.html)
    * [base/ggplot2]メニュー内に代表的なグラフの描き方を紹介しています

　  

* [ggplot2逆引き <i class="fa fa-external-link"></i>](http://yutannihilation.github.io/ggplot2-gyakubiki/)
* [グラフ描画ggplot2の辞書的まとめ20のコード <i class="fa fa-external-link"></i>](https://mrunadon.github.io/ggplot2/)
* [ggplot2 — きれいなグラフを簡単に合理的に  <i class="fa fa-external-link"></i>](https://heavywatal.github.io/rstats/ggplot2.html)
* [Rのグラフィック作成パッケージ“ggplot2”について <i class="fa fa-external-link"></i>](http://id.fnshr.info/2011/10/22/ggplot2/)
* [公式Reference（英語） <i class="fa fa-external-link"></i>](http://ggplot2.tidyverse.org/reference/index.html)


## License
CC BY-NC-SA 4.0, Sampo Suzuki