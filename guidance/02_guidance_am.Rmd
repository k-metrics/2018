---
title: "第２回データ分析勉強会"
author: "【午前の部】データハンドリング入門 [鈴木さんぽう, CC BY-NC-SA 4.0]"
date: "`r format(Sys.Date(), format = '%Y年%m月%d日')`"
output:
  ioslides_presentation:
    css: style.css
    df_print: paged
    logo: fig/hex-tidyverse.png
    smaller: false
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

require(tidyverse)
```


## 本日の内容
1. **分析環境の構築と確認（必要に応じて）**
1. データハンドリング入門（午前または午後）
    * 整然データ（tidy data）とは？
    * tidyverseとは？
    * パイプ演算子（` %>% `）
    * dplyr, tidyr, tibble
    * データハンドリング
1. データハンドリング入門（午後）
    * 演習

## 分析環境の構築と確認
* [概要説明資料](./01_guidance_am.html)
* [構築手順](https://k-metrics.github.io/cabinet/program/env_index.html)


## 本日の内容
1. 分析環境の構築と確認（必要に応じて）
1. **データハンドリング入門（午前または午後）**
    * 整然データ（tidy data）とは？
    * tidyverseとは？
    * パイプ演算子（` %>% `）
    * dplyr, tidyr, tibble
    * データハンドリング
1. データハンドリング入門（午後）
    * 演習


# データハンドリング入門


## 整然データとは？
* **整然データ**（tidy data）とはデータハンドリングを習得する上で**知っておくべき概念**
    * 一言で表すと「（Coddの）第三正規形」
    * [整然データとは何か (Colorless Green Ideas)](http://id.fnshr.info/2017/01/09/tidy-data-intro/)
    * [整然データってなに？ (Speaker Deck)](https://speakerdeck.com/fnshr/zheng-ran-detatutenani)
    * 整然データが理解できればデータハンドリングは理解できたようなもの

　  

* Rで最も使うデータ・フレーム型は整然データにしておくべき
    * ただし、人間が見ると分かりにくい面もある
    * 人間が分かりやすい（記録しやすい）雑然データへの変換は簡単


## tidyverseとは？
* The tidyverse is an opinionated collection of R packages designed for data science.
    * ggplot2, dplyr, tidyr,tibbleなどのパッケージ群を取りまとめているパッケージ
    * tidyなアーキテクチャに基づいたパッケージ群
        * パイプ演算子による処理を前提とした引数設計
    
```{r, comment=""}
tidyverse::tidyverse_packages()
```


## パイプ演算子（`%>%`）
パイプ演算子は`magrittr`パッケージで定義されている**左辺を右辺（の関数の第一引数）へ渡す**演算子です（`pipeR`パッケージのパイプ演算子とは別です）。
```{r, eval=FALSE}
summary(iris)
```
はパイプ演算子を用いると
```{r, eval=FALSE}
iris %>% summary()
```
と書くことができます。数珠つなぎにして複数の計算を分かりやすく記述できます。
```{r, eval=FALSE}
iris %>% 
  dplyr::filter(Species != "setosa") %>% 
  dplyr::group_by(Species) %>% 
  dplyr::summarise_if(is.numeric, funs(mean), na.rm = TRUE)
```


## パイプ演算子（`%>%`）
先ほどの例をパイプ演算子を使わないで記述すると以下のようになります。
```{r, eval=FALSE}
  dplyr::summarise_if(
    dplyr::group_by(
      dplyr::filter(iris, Species != "setosa"), Species
    ), is.numeric, funs(mean), na.rm = TRUE
  )
```
中間変数を用いると以下のようになります。
```{r, eval=FALSE}
tmp1 <- dplyr::filter(iris, Species != "setosa")
tmp2 <- dplyr::group_by(tmp1, Species)
dplyr::summarise_if(tmp2, is.numeric, funs(mean), na.rm = TRUE)
```
この例からわかるようにパイプ演算子を用いることで分かりやすく修正しやすいコードが記述できることがわかると思います。


## dplyr
`dplyr`パッケージは整然データを効率的に扱う関数がまとめられた追加パッケージで以下のような関数が用意されています。

* 抽出・選択 : `sample_n`, `sample_frac`, `select`, `filter`, `distinct`
* 要約・集計 : `summarise`, `summarize`, `summarise_if`, `count`, `group_by`
* 追加・結合 : `mutate`, `mutate_if`, `left_join`, `full_join`, `bind_rows`

```{r}
iris %>% dplyr::sample_n(3)
```


## tidyr
`tidyr`パッケージはデータ構造を操作するための関数がまとめられた追加パッケージで以下のような関数が用意されています。

* 変形 : `gather`, `spread`
* 分離 : `separate`

```{r}
iris %>% 
  tidyr::gather(key, value, -Species) %>% 
  head(3)
```


## tibble
`tibble`パッケージはデータフレームをより使いやすくするための関数がまとめられた追加パッケージです。

* 便利 : `rowid_to_column`, `rownames_to_column`, `column_to_rownames`

```{r}
iris %>% 
  tibble::rowid_to_column("id") %>% 
  head(3)
```


## データハンドリング
* [dplyrのすゝめ](https://k-metrics.github.io/cabinet/program/basics_dplyr.html)
    * [dplyr](https://heavywatal.github.io/rstats/dplyr.html)
    * [tidyr](https://heavywatal.github.io/rstats/tidyr.html)
    * [readr](https://heavywatal.github.io/rstats/readr.html)

* 更に知りたい人のために
    * [tidyverse](https://www.tidyverse.org/)
    * [dplyr, part of tidyverse](http://dplyr.tidyverse.org/index.html)
    * [俺たちのtidyverseはこれからだ！](http://notchained.hatenablog.com/entry/tidyverse)


## License
CC BY-NC-SA 4.0, Sampo Suzuki