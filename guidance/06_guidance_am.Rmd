---
title: "第６回データ分析勉強会"
output: 
  html_document:
    df_print: paged
    css: style.css
#    code_folding: none
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

require(redmineR)
require(lubridate)    # 日時を扱うパッケージ(tidyverseシリーズ)
require(tidyverse)    # tidyverseは最後に呼び出す方がコンフリクトの影響小
```

# Redmineへアクセスしてみる。

## redmineRをインストールする。

`redmineR`インストールの前に、`remotes`というパッケージをインストールしておく必要があるらしい。

<!-- チャンクはRにしておくとコードハイライトが有効になる -->
```{r, eval=FALSE}
devtools::install_github("openanalytics/redmineR")
```

`redmineR`を読み込めればOK

```{r, eval=FALSE}
library(redmineR)
```

## Redmineの情報を入力する。

URLとAPIアクセストークンを環境変数に指定する。  
APIアクセストークンはRedmineにログインして、個人設定ページから入手する。  

```{r, eval=FALSE}
Sys.setenv("REDMINE_URL" = "http://xxx.xxx.xxx/xxx")
Sys.setenv("REDMINE_TOKEN" = "APIACCESSTOKEN")
```

<!-- こうすると実行はされるけどコードは表示されない -->
```{r, include=FALSE}
Sys.setenv("REDMINE_URL" = "https://www.redmine.org/")
Sys.setenv("REDMINE_TOKEN" = "APIACCESSTOKEN")
```

## 動作確認
プロジェクトの一覧取得とかが軽めのAPIでおすすめ。
<!-- `redminer_df`クラスは何故かpaged表示をしてくれないので、表示の際はデータフレームに変換しておくと見やすい-->
```{r context="data"}
redmineR::redmine_projects() %>% as.data.frame()
```

# チケットデータを取得する。

## チケット一覧を取得する。

`redmine_issues`でチケット一覧を取得する。  
デフォルトだとクローズしたチケットを取得して来れない。  
全てのステータスのチケットを取得するためには`status_id = "*"`を指定する。

```{r, eval=FALSE}
issues <- redmineR::redmine_issues(status_id = "*")
# save(issues, file = "../data/_redmine_issues_all.RData")
```
皆様はこちらをお使いください。サンプル用データロードします。
```{r}
# .RDataはGitHubのデフォルトではignore対象なので、".RData_"に変えてあります
load("../data/_redmine_issues_all.RData_")
# save(issues, file = "../data/_redmine_issues_all.RData")
```

## redmineRで取ってきたチケットを見てみる

```{r}
issues %>% head(100) %>% as.data.frame()
```

リストから選ぶ系のフィールドが`<list [2]>`になってしまっている。
```{r}
issues$project[[1]]
```

リスト型のカラムは`NA`なこともある。
```{r}
issues %>% head(100) %>%
  dplyr::select(id, assigned_to, category) %>%
  as.data.frame()
```



日付が文字列型になってしまっている。
```{r}
issues %>% head(100) %>%
  dplyr::select(id, created_on, closed_on, updated_on, start_date, due_date) %>% 
  as_data_frame()
```

各カラムの型
```{r}
sapply(issues,class) %>% as.data.frame()
```


# データを整形する。

```{r}
# リスト型変数にNAが含まれていても展開するための関数（）
map_if_chr <- function(.x, .f) {
  purrr::map_if(.x, !is.na(.x), .f) %>% 
    purrr::map_chr(1L) %>% 
    return()
}

df <- issues %>% 
  # dplyr::sample_n(100) %>%   # テスト用に１００件に絞る
  # custom_fieldsが上手く展開できない...
  dplyr::select(-custom_fields) %>% 
  dplyr::mutate(
    pjid = purrr::map_int(project, 'id'),     # 一種のキーなのでNAはありえない
    project = map_if_chr(project, 'name'),
    tracker = map_if_chr(tracker, 'name'),
    status = map_if_chr(status, 'name'),
    priority = map_if_chr(priority, 'name'),
    author = map_if_chr(author, 'name'),
    assigned_to = map_if_chr(assigned_to, 'name'),
    category = map_if_chr(category, 'name'),
    created_on = lubridate::ymd_hms(created_on, tz = "UTC"),
    updated_on = lubridate::ymd_hms(updated_on, tz = "UTC"),
    closed_on = lubridate::ymd_hms(closed_on, tz = "UTC"),
    # custom_fields = map_if_chr(custom_fields, 'name'),
    fixed_version = map_if_chr(fixed_version, 'name'),
    start_date = lubridate::as_date(start_date),
    due_date = lubridate::as_date(due_date),
    parent = map_if_chr(parent, 'id')
  )
# データ数が多すぎてレンダリングに時間がかかりすぎるので先頭100行のみとする
head(df, 100)
# %>% readr::write_excel_csv(., path = "../data/_redmine_issues_all.csv")
```
以下、説明

## リスト型
リスト型変数は任意の型で任意の数のデータを任意な数だけ持てる柔軟性のあるデータ構造です。リスト型の中にリスト型をネストさせることも可能です。    
```{r}
list(list(id = c(1, 2)), list(name = c("Defects")))
```

## リスト型の処理
このようなリスト型変数を扱うには`purrr`パッケージ（part of tidyverse）が便利です。例えばチケットの`project`データは以下のような構成になっています。    
```{r}
issues %>% head(1) %>% dplyr::select(project) %>% purrr::flatten()
```
この中から`name`だけを取り出すには`purrr::map`関数群を用います。
```{r}
issues %>% head() %>% dplyr::select(project) %>% 
  dplyr::mutate(pjname_l = purrr::map(project, 'name'),
                pjname_v = purrr::map_chr(project, 'name'))
```
関数によって返り値が異なるので注意してください。

## `NA`の処理
`NA`が含まれる場合は`purrr::map_if`関数を用います。
```{r}
issues %>% dplyr::sample_n(100) %>% dplyr::select(assigned_to) %>% 
  dplyr::mutate(name_l = purrr::map_if(assigned_to, !is.na(assigned_to), 'name'),
                name_v = purrr::map_chr(purrr::map_if(assigned_to,
                                                      !is.na(assigned_to), 'name'),
                                        1L))
```

`NA`が入っているカラムは`ifelse`で`NA`じゃなかった場合のみ、
`list`の要素にアクセスするようにしないと、エラーになってしまう。

```{r error=TRUE}
  df[i, "category"] <- 
    ifelse(is.na(issues[i, "category"]), NA, issues[i, "category"][[1]]$name)
```

## created_onなどをDate型に修正
文字列を日付型に変換するには`lubridate`パッケージを使うと分かりやすい。
<!-- `as.Date.POSIXct`で日付型に変換する。 -->

```{r}
lubridate::as_date("2018/10/05")
```


# 可視化する。

## 棒グラフ

```{r}
df %>% ggplot(aes(x = status)) +
  geom_bar() + theme_bw(base_family = "HiraKakuProN-W3")
```

## 円グラフ

```{r pie-chart-chunk}
df %>% ggplot(aes(x="", fill=tracker)) +
  geom_bar(width = 1) + coord_polar("y") + theme_bw(base_family = "HiraKakuProN-W3")
```


# Open/Closeチャートを描く。

## Openチャートを作る

```{r}
open <- df %>% 
  mutate(
    created_on = lubridate::as_date(created_on)
  ) %>% 
  dplyr::group_by(created_on) %>% 
  dplyr::count() %>% 
  dplyr::rename(date = created_on,
                open = n)
open
```

## Closeチャートを作る

```{r}
close <- df %>% 
  dplyr::filter(status=="Closed") %>% 
  dplyr::mutate(closed_on = lubridate::as_date(closed_on)) %>% 
  dplyr::group_by(closed_on) %>% 
  dplyr::count() %>% 
  dplyr::rename(
    date = closed_on,
    close = n
  )
close
```


## openとcloseを結合

```{r}
max_date <- max(open$date, close$date)
min_date <- min(open$date, close$date)
openclose <- data.frame(date=seq(min_date, max_date, by = "day")) %>% 
  dplyr::left_join(open, by = "date") %>%
  dplyr::left_join(close, by = "date") %>% 
  replace_na(list(open=0, close=0))

openclose
```

## Open/Closeチャートを描く

```{r}
openclose$cumsum_open <- cumsum(openclose$open)
openclose$cumsum_close <- cumsum(openclose$close)
openclose
```

## Open/Closeチャートを描く

```{r}
openclose %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = cumsum_close, color = "cumsum_close")) +
  geom_line(aes(y = cumsum_open, color = "cumsum_open"))
```
