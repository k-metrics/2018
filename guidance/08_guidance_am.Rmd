---
title: "第８回データ分析勉強会"
author: "【午前の部/午後の部】多変量データを分析する [鈴木さんぽう, CC BY-NC-SA 4.0]"
date: "`r format(Sys.Date(), format = '%Y年%m月%d日')`"
output:
  ioslides_presentation:
    css: style.css
    df_print: paged
    logo: fig/hex-rmarkdown.png
    smaller: false
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

require(tidyverse)
```


## 本日の内容
1. **（午前）**
    * 概説
1. （午後）
    * 演習（レポート作成）



# イントロダクション

## 多変量（データ）解析とは？
**多変量解析**（multivariate analysis）とは文字通り多くの変量（変数）を用いてデータを統計的に扱う手法の総称。**モデリング**だけでなくデータマイニングなどの**探索**に用いられることも多い。  

主な多変量解析の手法

* 重回帰分析
* 主成分分析
* 因子分析
* クラスター分析
* コンジョイント分析

## 多変量（データ）解析の手法
多変量解析には前述のように様々な手法があり、目的に応じて使い分ける必要がある。  

1) 予測や制御  
線形単回帰のように**目的変数と説明変数の関係**を統計モデルとし、それに基づく予測を行いたい場合に用いる

    * 連続データ：重回帰分析、分散分析
    * カテゴリカルデータ：判別分析、ロジスティク回帰分析

2) 集約や探索  
データが持つ情報を集約したり**変量の関係**を知りたい場合に用い、近年、データマイニングなどにも使われる

    * 主成分分析、因子分析
    * クラスター分析（データを分類したい場合）



# 予測や制御を行う

## 変量（変数）間の関係
予測などを行う前に変量間の関係を把握しておくことが大切。変量間の関係は下記に分類できる。  

* **因果**関係（Causality）
    * 原因から結果へ一方的な関係
    * 予測や制御に用いることができる
* **回帰**関係（Regression）
    * 因果関係と同様な一方的な関係（ただし、因果関係はない）
    * 予測に用いることができる
* **相関**関係（Correlation）
    * 関係性があることしか言えない（双方向の関係）
    * ゆえに予測や制御には使えない


## 重回帰分析
（線形）重回帰分析では一般的に下記のような回帰式（$n = 1, 2, ...$）を用いる。

$$y = b_{0} + b_{1}x_{1} + b_{2}x_{2} + ... + b_{n}x_{n}$$

この回帰式からは  

* 説明変数（与えられた値）から目的変数を**予測**する
* 目的変数の値を大きく（または小さく）するには説明変数（これから与える値）をどうする（**制御**）か

重回帰分析では上記のような線形モデル以外にも、交互作用モデル、2次式モデル、共分散分析モデル、一般線形化モデルなど様々なモデルを作ることができる。

$$y = b_{0} + b_{1}x_{1} + ... + b_{n}x_{n} + b_{12}x_{1}x_{2} + ... + b_{(n-1)n}x_{n-1}x_{n}$$


## モデル式の評価
（線形）重回帰モデルを評価するには線形単回帰モデルと同様に決定係数（自由度調整済み）とp値に着目する。  

### 自由度調整済み決定係数
```{r}
lm(mpg ~ cyl + disp + hp + drat + wt, data = mtcars) %>% broom::glance()
```
　  
**自由度調整済み決定係数**（adj.r.squared）は説明変数が目的変数の変動の何パーセントを説明できているかを意味する値でこの場合は約$82\%$を説明できている。一方、**p値**（p.value）は回帰式自体の有意性を表している。


## モデル式の評価（つづき）
モデル式自体の評価を行ったら次に**回帰係数**をp値（p.value）を用いて評価する。  

### 回帰係数p値
```{r}
lm(mpg ~ cyl + disp + hp + drat + wt, data = mtcars) %>% broom::tidy()
```
　  
　　この場合、切片と`cyl`、`hp`、`wt`を除いて適しているとは言い難い。


## 変数選択 
このような場合、AIC値（赤池情報量基準）を元にしたステップワイズ変数選択を用いて最も適していると考えらえる変量を選択する方法がある。
```{r, include=FALSE}
result <- step(lm(mpg ~ cyl + disp + hp + drat + wt, data = mtcars)) %>%
  broom::tidy()
```

```{r, eval=FALSE}
step(lm(mpg ~ cyl + disp + hp + drat + wt, data = mtcars)) %>%
  broom::tidy()
```

```{r, echo=FALSE}
result
```

このモデル式では自由度調整済み決定係数が$0.8263$であり、先程のモデルよりは多くの変動を説明できていることが分かる。



# 集約や探索を行う

## 次元縮約
主成分分析や因子分析の目的である次元縮約とは多数ある変量をより少数の次元に要約することで変量の関係を把握しやすくするための手法です。次元縮約することで下表のようなことができるようになります。  

　 | 主成分分析     | 因子分析 
:-:|----------------|---
1  | 共通因子の探索 | 共通因子の探索
2  |　              | 独自要因の推定
3  | 重みつき合計   | 
4  | 可視化         | 


## 主成分分析
主成分分析は前述の次元縮約を使って任意数の変量（変数）から「共通因子」を探索し「可視化」できる分析方法。乱暴にいえばｎ次元空間の変量（変数）の関係を２次元空間の主成分の関係へ写像する方法。  

![　『主成分分析について具体的な過程抜きでざっくり』より引用](./fig/PCA_image.png)


## 分析手順
主成分分析は以下の手順で行う  

* 第一主軸としてｎ次元空間の中で最も分散の大きくなる軸を探す
* 第二主軸として第一主軸に直行し最も分散が大きくなる軸を探す
* 第三主軸として第一、第二主軸に直行し最も分散が大きくなる軸を探す
* 以降、同様に第ｎ主軸までを探す
* 各主成分軸上での個々の変数の座標値（主成分得点）を求める
* 指標を使用して主成分数を決める
    * 累積**分散説明率**
    * １を超える**固有値の数**
    * 固有値の折れ線の**屈曲点** − １


## 分散の再配分
主成分分析は各変量の分散を分散の総和を変えずに各主成分の分散に再分配する分析。  

### 変量の分散総和と各変量の分散
```{r, echo=FALSE}
mtcars %>% dplyr::select(wt, qsec, am) %>% 
  dplyr::summarize_all(.funs = var, na.rm = TRUE) %>% 
  tidyr::gather(key, value) %>% 
  dplyr::mutate(sum = sum(value)) %>% 
  tidyr::spread(key, value)
```

### 主成分得点の分散総和と主成分得点の分散
```{r, echo=FALSE}
mtcars %>% dplyr::select(wt, qsec, am) %>% 
  prcomp(scale. = FALSE) %>% broom::tidy() %>% 
  tidyr::spread(key = PC, value = value) %>% 
  dplyr::select(-row) %>% 
  dplyr::summarize_all(.funs = var, na.rm = TRUE) %>% 
  tidyr::gather(key, value) %>% 
  dplyr::mutate(sum = sum(value)) %>% 
  tidyr::spread(key, value) %>% 
  dplyr::rename(PC1 = `1`, PC2 = `2`, PC3 = `3`)
```


## 分散説明率
分散説明率とは分散の総和に対する各主成分得点の分散の比のこと。

### 主成分得点の分散総和と主成分得点の分散
```{r, echo=FALSE}
mtcars %>% dplyr::select(wt, qsec, am) %>% 
  prcomp(scale. = FALSE) %>% broom::tidy() %>% 
  tidyr::spread(key = PC, value = value) %>% 
  dplyr::select(-row) %>% 
  dplyr::summarize_all(.funs = var, na.rm = TRUE) %>% 
  tidyr::gather(key, value) %>% 
  dplyr::mutate(sum = sum(value)) %>% 
  tidyr::spread(key, value) %>% 
  dplyr::rename(PC1 = `1`, PC2 = `2`, PC3 = `3`)
```

### 主成分得点の分散総和と分散説明率
```{r, echo=FALSE}
mtcars %>% dplyr::select(wt, qsec, am) %>% 
  prcomp(scale. = FALSE) %>% broom::tidy() %>% 
  tidyr::spread(key = PC, value = value) %>% 
  dplyr::select(-row) %>% 
  dplyr::summarize_all(.funs = var, na.rm = TRUE) %>% 
  tidyr::gather(key, value) %>% 
  dplyr::mutate(sum = sum(value)) %>% 
  tidyr::spread(key, value) %>% 
  dplyr::mutate(PC1 = `1`/sum, PC2 = `2`/sum, PC3 = `3`/sum) %>% 
  dplyr::select(sum, PC1, PC2, PC3)
```

この場合、第一、第二主成分得点で全体の$98\%$が説明できることが分かる。  


## 固有値
固有値は各変量の主成分負荷量の二乗和。主成分負荷量は主成分得点と変量の相関係数。

### 主成分負荷量
```{r, echo=FALSE}
result <- mtcars %>% 
  dplyr::select(wt, qsec, am) %>% 
  prcomp(scale. = FALSE)

t(t(result$rotation) * result$sdev) %>% as.data.frame()
```

### 固有値
```{r, echo=FALSE}
t(result$sdev ^ 2) %>% 
  as.data.frame() %>% 
  dplyr::rename(PC1 = V1, PC2 = V2, PC3 = V3)
```


## 主成分分析の可視化
主成分分析により求められた第一、第二主成分を用いて可視化することでデータの関係を把握しやすくなります。可視化には`ggbiplot`関数が便利です。
```{r, echo=FALSE}
iris %>% dplyr::select(-Species) %>% prcomp(scale. = FALSE) %>% 
  ggbiplot::ggbiplot(obs.scale = 1, var.scale = 1, ellipse = FALSE,
                     circle = TRUE, groups = as.factor(iris$Species))

mtcars %>% dplyr::select(wt, qsec, am) %>% prcomp(scale. = FALSE) %>% 
  ggbiplot::ggbiplot(obs.scale = 1, var.scale = 1, ellipse = FALSE,
                     circle = TRUE, groups = as.factor(mtcars$cyl))
```


## 単純構造化
「全ての主成分得点の分散 = 1」かつ「第kと第l（$\neq$k）成分得点は無相関」かつ「誤差の値を変えない」という条件下であれば主成分得点を任意に変換（回転）できる。負荷量（回転後の主成分得点）に「$0$」が多くなるように回転するとより合理的な説明がしやすくなる。  

# 演習

## 対象データ
以下のデータは[セリーグの個人投手成績（10/3時点）](http://npb.jp/bis/2018/stats/pit_c.html)です。主成分分析を用いて成績上位の投手がどのような特徴を持っているか分析してください。  

```{r, echo=FALSE}
readr::read_csv("./data/pitc.csv", locale = locale(encoding = "CP932")) %>% 
  dplyr::select(-`ホール`)
```


## 主成分分析結果（回転済）
```{r, echo=FALSE}

header <- readr::read_csv("./data/pitc.csv", locale = locale(encoding = "CP932")) %>% 
  dplyr::select(row = `順位`, `投手名`, `チーム`)

readr::read_csv("./data/pitc.csv", locale = locale(encoding = "CP932")) %>% 
  dplyr::select(-`順位`, -`投手名`, -`チーム`, -`ホール`) %>% 
  prcomp(., scale. = TRUE) %>% 
  broom::tidy() %>% 
  tidyr::spread(key = PC, value = value) %>% 
  dplyr::left_join(header, ., by = "row") %>% 
  dplyr::select(-row)
```


## 主成分分析結果（可視化）
```{r, echo=FALSE}
header <- readr::read_csv("./data/pitc.csv", locale = locale(encoding = "CP932")) %>% 
  dplyr::select(row = `順位`, `投手名`, `チーム`) %>% 
  dplyr::mutate(`投手名` = paste(row, `投手名`, sep = "_"))

readr::read_csv("./data/pitc.csv", locale = locale(encoding = "CP932")) %>% 
  dplyr::select(-`順位`, -`投手名`, -`チーム`, -`ホール`) %>% 
  prcomp(., scale. = TRUE) %>% 
  ggbiplot::ggbiplot(obs.scale = 1, var.scale = 1, ellipse = TRUE, circle = TRUE,
                     labels = header$投手名)
```


## 主成分プロット
```{r, echo=FALSE}
header <- readr::read_csv("./data/pitc.csv", locale = locale(encoding = "CP932")) %>% 
  dplyr::select(row = `順位`, `投手名`, `チーム`) %>% 
  dplyr::mutate(`投手名` = paste(row, `投手名`, sep = "_"))

readr::read_csv("./data/pitc.csv", locale = locale(encoding = "CP932")) %>% 
  dplyr::select(-`順位`, -`投手名`, -`チーム`, -`ホール`) %>% 
  prcomp(., scale. = TRUE) %>% 
  broom::tidy() %>% 
  tidyr::spread(key = PC, value = value) %>% 
  dplyr::right_join(header, by = "row") %>% 
  dplyr::select(row, `投手名`, `チーム`, PC1 = `1`, PC2 = `2`) %>% 
  ggplot2::ggplot(ggplot2::aes(x = PC1, y = PC2, colour = `チーム`)) + 
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0)) +
    ggplot2::geom_vline(ggplot2::aes(xintercept = 0)) + 
    ggplot2::geom_point() + 
    ggrepel::geom_label_repel(ggplot2::aes(label = `投手名`))
```


## 復習のためのリソース

* [gacco 統計学III]()
* [Rで主成分分析](https://www.casleyconsulting.co.jp/blog/engineer/119/)

* [主成分分析とは <i class="fa fa-external-link"></i>](https://www.intage.co.jp/glossary/401/){target="_blank" title=""}

## enjoy!

CC BY-NC-SA 4.0, Sampo Suzuki